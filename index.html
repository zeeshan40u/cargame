<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelPoint</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <style>
/* --- Modal Styles --- */
#musicModal {
    display: none;
    position: fixed;
    z-index: 99999;
    left: 0; top: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    font-family: 'Segoe UI', Arial, sans-serif;
}
#musicModal .modal-content {
    background: #232946;
    color: #fff;
    padding: 32px 24px;
    border-radius: 18px;
    box-shadow: 0 6px 24px rgba(0,0,0,0.3);
    text-align: center;
    min-width: 320px;
    max-width: 80vw;
    margin: auto;
    position: relative;
}
#musicModal .modal-content p {
    font-size: 1.2em;
    margin-bottom: 30px;
    font-weight: 500;
    letter-spacing: 0.02em;
}
#musicModal .modal-btns {
    display: flex;
    justify-content: space-between;
    gap: 24px;
}
.modal-btn {
    flex: 1 1 0;
    padding: 12px 0;
    border-radius: 12px;
    border: none;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}
.modal-btn.yes {
    background: linear-gradient(90deg, #4f8cff 0%, #1ec1a6 100%);
    color: #fff;
    box-shadow: 0 2px 10px rgba(79,140,255,0.15);
}
.modal-btn.yes:hover {
    background: linear-gradient(90deg, #1ec1a6 0%, #4f8cff 100%);
}
.modal-btn.cancel {
    background: #fff;
    color: #232946;
    border: 2px solid #4f8cff;
}
.modal-btn.cancel:hover {
    background: #f5f7fa;
    color: #1ec1a6;
    border-color: #1ec1a6;
}
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #222;
            font-family: sans-serif;
            overflow: hidden;
            position: relative;
        }
        
        /* Game Container Styling */
        .game-container {
            position: relative;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            background-color: #111; 
            border: 3px solid transparent;
            transition: border-color 0.3s;
        }

        .game-container.nitro-active {
            border-color: #ffd700;
        }

        .game-container.shield-active {
            border-color: #00bfff;
        }

        .game-container.disaster-active {
            animation: fire-border 0.5s infinite alternate;
        }

        @keyframes fire-border {
            from { border-color: #ff4500; }
            to { border-color: #ffa500; }
        }

        /* Canvas (Road) Styling */
        #racing-canvas {
            display: block;
            background: #666; /* Road color */
            width: 320px; /* Decreased */
            height: 600px; /* Decreased */
        }

        /* Overlays and Text */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
        }
        
        .overlay h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        /* Button Styling */
        .control-btn {
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #00ff55;
            color: #111;
            transition: background-color 0.3s, opacity 0.5s;
        }

        .retry-btn {
            opacity: 0;
        }

        .fade-in {
            transition: opacity 0.5s ease-in;
            opacity: 1;
        }

        /* Score Display */
        .score-display {
            position: absolute;
            top: 10px;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 5px black;
            z-index: 20;
        }

        #score {
            left: 10px;
        }

        #high-score {
            right: 10px;
        }
        
        /* Nitro and Shield Button Styling */
        .booster-btn {
            position: absolute;
            bottom: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: gray;
            color: white;
            font-size: 0.8em;
            padding: 0;
            overflow: hidden;
            border: none;
            cursor: default;
            z-index: 20;
        }
        
        #nitroBtn { right: 20px; }

        .fill-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            transition: height 0.1s linear;
        }
        
        #nitroFill { background-color: #00ff55; }

        .booster-btn.ready {
            cursor: pointer;
            box-shadow: 0 0 15px #00ff55;
        }

        .booster-btn.ready #nitroFill { background-color: #00ff55; }

        .booster-btn.using {
            box-shadow: 0 0 20px yellow;
        }

        .booster-btn span {
            position: relative;
            z-index: 2;
        }
        
        /* Nitro Active Effects */
        .color-cycle-animation {
            animation: colorShift 0.5s infinite alternate;
        }

        @keyframes colorShift {
            from { background-color: #111; }
            to { background-color: #220022; }
        }

        /* Music Toggle Button CSS */
        .music-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #ccc;
            background-color: #333;
            color: white;
            font-size: 24px;
            line-height: 50px;
            padding: 0;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s, color 0.2s;
            z-index: 20;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .music-btn.off {
            color: #FF4500;
            border-color: #FF4500;
        }

        /* Shield Display */
        #shieldDisplay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 80px;
            height: 60px;
            background-color: rgba(0, 170, 255, 0.2);
            border: 2px solid #00aaff;
            border-radius: 10px;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            text-shadow: 0 0 5px #000;
            z-index: 20;
            pointer-events: none; /* Make it non-clickable */
            box-shadow: 0 0 15px #00aaff;
            opacity: 1;
        }
        #shieldDisplay.hide {
          opacity: 0;
          transition: opacity 0.5s ease-out;
        }
    </style>
</head>
<body>
    <audio id="bg-music" src="cargamebg.mp3" autoplay loop muted></audio>
    
    <div id="high-score" class="score-display">High Score: 0</div>
    <div id="score" class="score-display">Score: 0</div>
    
    <div class="game-container" id="gameContainer">
        <canvas id="racing-canvas" width="320" height="600"></canvas>
        <div id="introOverlay" class="overlay">
            <h1>PixelPoint</h1>
            <p>Use your mouse or touch to steer!</p>
            <button id="playButton" class="control-btn fade-in" style="opacity: 1;">Start Game</button>
        </div>
        
        <button id="musicToggle" class="control-btn music-btn off">üîá</button>
        <button id="nitroBtn" class="booster-btn" disabled>
            <div id="nitroFill" class="fill-bar"></div>
            <span>NITRO</span>
        </button>

        <div id="shieldDisplay" style="display: none;">
            <span>üõ°Ô∏è</span>
            <span id="shieldTime"></span>
        </div>
    </div>
<!-- Music Modal -->
<div id="musicModal">
  <div class="modal-content">
    <p>For more enjoyment, please turn on the bg music button.</p>
    <div class="modal-btns">
      <button class="modal-btn yes">Yes</button>
      <button class="modal-btn cancel">Cancel</button>
    </div>
  </div>
</div>
<script>
    // ========================= üéÆ GAME SETUP =========================
const gameContainer = document.getElementById("gameContainer");
const introOverlay = document.getElementById("introOverlay");
const playButton = document.getElementById("playButton");
const canvas = document.getElementById("racing-canvas");
const ctx = canvas.getContext("2d");

const scoreDisplay = document.getElementById("score");
const highScoreDisplay = document.getElementById("high-score");
const nitroBtn = document.getElementById("nitroBtn");
const nitroFill = document.getElementById("nitroFill");
const shieldDisplay = document.getElementById("shieldDisplay");
const shieldTimeDisplay = document.getElementById("shieldTime");

const bgMusic = document.getElementById("bg-music");
const musicToggle = document.getElementById("musicToggle");
const musicModal = document.getElementById("musicModal");
const modalYes = musicModal.querySelector('.yes');
const modalCancel = musicModal.querySelector('.cancel');

// ========================= üéµ SOUND EFFECTS =========================
const overtakeSynth = new Tone.PluckSynth({
  dampening: 2000,
  resonance: 0.9,
  volume: -5
}).toDestination();

const nitroSynth = new Tone.NoiseSynth({
  "volume": -10,
  "envelope": { "attack": 0.001, "decay": 0.2, "sustain": 0.05, "release": 0.2 },
  "filter": { "Q": 6, "type": "lowpass", "frequency": 2000 }
}).toDestination();

const gameOverSynth = new Tone.MembraneSynth().toDestination();
const shieldSound = new Tone.Player("shieldcargame.mp3").toDestination();

const meteoroidSynth = new Tone.MetalSynth({
  "frequency": 200,
  "envelope": { "attack": 0.001, "decay": 0.1, "sustain": 0.05, "release": 0.2 },
  "harmonicity": 5.1,
  "modulationIndex": 32,
  "resonance": 4000,
  "octaves": 1.5,
  "volume": -5
}).toDestination();

const blastSynth = new Tone.NoiseSynth({
  "volume": -5,
  "envelope": { "attack": 0.001, "decay": 0.5, "sustain": 0, "release": 0.2 }
}).toDestination();

// ========================= üé∂ MUSIC STATE =========================
let musicEnabled = localStorage.getItem('musicEnabled') === 'true';

function initializeMusic() {
  if (bgMusic) {
    bgMusic.volume = 0.25;
    bgMusic.muted = !musicEnabled;

    if (musicEnabled) {
      musicToggle.textContent = 'üîä';
      musicToggle.classList.remove('off');
    } else {
      musicToggle.textContent = 'üîá';
      musicToggle.classList.add('off');
    }
  }
}
initializeMusic();

// ========================= ‚öôÔ∏è GAME VARIABLES =========================
let player, obstacles, shields, disasters, score, highScore, gameOver;

const BASE_GAME_SPEED = 3;
let gameSpeed = BASE_GAME_SPEED;
let backgroundSpeed = BASE_GAME_SPEED;

let nitroActive = false, nitroDuration = 0, nitroCooldown = 0;
let shieldActive = false, shieldDuration = 0;
let disasterActive = false, disasterDuration = 0;

let meteors = [];
let roadLines = [];
let smokeParticles = [];
let explosionParticles = [];
let isDragging = false;
let endGameEffect = false;
let shakeFrames = 0;

// ========================= ‚ö° CONSTANTS =========================
const NITRO_SPEED_MULTIPLIER = 2.5;
const NITRO_DURATION_FRAMES = 480;
const NITRO_COOLDOWN_FRAMES = 720;

const SHIELD_DURATION_FRAMES = 600;
const SHIELD_SPAWN_RATE = 0.0005;

const DISASTER_SPAWN_RATE = 0.0005;
const DISASTER_DURATION_FRAMES = 120;

const ROAD_LINE_COUNT = 3;
const ROAD_LINE_WIDTH = 5;
const ROAD_LINE_LENGTH = 50;
const ROAD_LINE_SPACING = 80;

// ========================= üöó CAR DESIGN =========================
const playerCarDesign = [
  ['T', 'T', 'D', 'D', 'D', 'D', 'T', 'T'],
  ['T', 'D', 'L', 'L', 'L', 'L', 'D', 'T'],
  ['D', 'L', 'G', 'G', 'G', 'G', 'L', 'D'],
  ['D', 'L', 'G', 'G', 'G', 'G', 'L', 'D'],
  ['T', 'D', 'L', 'L', 'L', 'L', 'D', 'T']
];

const opponentCarDesign = [
  ['T', 'T', 'R', 'R', 'R', 'R', 'T', 'T'],
  ['T', 'R', 'O', 'O', 'O', 'O', 'R', 'T'],
  ['R', 'O', 'B', 'B', 'B', 'B', 'O', 'R'],
  ['R', 'O', 'B', 'B', 'B', 'B', 'O', 'R'],
  ['T', 'R', 'O', 'O', 'O', 'O', 'R', 'T']
];

const colors = {
  'T': '#00000000',
  'D': '#444444',
  'L': '#CCCCCC',
  'G': '#00FF00',
  'R': '#FF0000',
  'O': '#FFAA00',
  'B': '#0000FF'
};

// ========================= üõ† UTILITY =========================
function lerp(start, end, amt) {
  return (1 - amt) * start + amt * end;
}

function drawCar(x, y, design, rotation = 0, scale = 6) {
  ctx.save();
  ctx.translate(x + (design[0].length * scale) / 2, y + (design.length * scale) / 2);
  ctx.rotate(rotation);

  for (let row = 0; row < design.length; row++) {
    for (let col = 0; col < design[row].length; col++) {
      const color = design[row][col];
      if (color !== 'T') {
        ctx.fillStyle = colors[color] || '#000';
        ctx.fillRect(
          col * scale - (design[0].length * scale) / 2,
          row * scale - (design.length * scale) / 2,
          scale,
          scale
        );
      }
    }
  }
  ctx.restore();
}

// ========================= üéÆ CORE GAME FUNCTIONS =========================
function resetGame() {
  player = { x: canvas.width / 2 - 24, y: canvas.height - 100, width: 48, height: 60, speed: 5 };
  obstacles = [];
  shields = [];
  disasters = [];
  meteors = [];
  smokeParticles = [];
  explosionParticles = [];
  roadLines = [];

  score = 0;
  gameOver = false;
  endGameEffect = false;

  nitroActive = false;
  nitroDuration = 0;
  nitroCooldown = 0;
  shieldActive = false;
  shieldDuration = 0;
  disasterActive = false;
  disasterDuration = 0;

  for (let i = 0; i < ROAD_LINE_COUNT; i++) {
    roadLines.push({
      x: canvas.width / 2 - ROAD_LINE_WIDTH / 2,
      y: i * (ROAD_LINE_LENGTH + ROAD_LINE_SPACING),
    });
  }
}

function drawRoadLines() {
  ctx.fillStyle = "#FFF";
  roadLines.forEach(line => {
    ctx.fillRect(line.x, line.y, ROAD_LINE_WIDTH, ROAD_LINE_LENGTH);
    line.y += backgroundSpeed;
    if (line.y > canvas.height) {
      line.y = -ROAD_LINE_LENGTH;
    }
  });
}
// ========================= üéÆ SPAWN FUNCTIONS =========================
function spawnObstacle() {
  const laneWidth = canvas.width / 3;
  const lane = Math.floor(Math.random() * 3);
  obstacles.push({
    x: lane * laneWidth + laneWidth / 2 - 24,
    y: -60,
    width: 48,
    height: 60,
    speed: gameSpeed
  });
}

function spawnShield() {
  if (Math.random() < SHIELD_SPAWN_RATE) {
    shields.push({
      x: Math.random() * (canvas.width - 30),
      y: -30,
      width: 30,
      height: 30,
      speed: gameSpeed
    });
  }
}

function spawnDisaster() {
  if (Math.random() < DISASTER_SPAWN_RATE) {
    disasters.push({
      x: Math.random() * (canvas.width - 30),
      y: -30,
      width: 30,
      height: 30,
      speed: gameSpeed
    });
  }
}

// ========================= üéÆ POWERUPS & EFFECTS =========================
function activateNitro() {
  if (!nitroActive && nitroCooldown === 0) {
    nitroActive = true;
    nitroDuration = NITRO_DURATION_FRAMES;
    nitroCooldown = NITRO_COOLDOWN_FRAMES;
    nitroSynth.triggerAttackRelease("8n");
  }
}

function activateShield() {
  shieldActive = true;
  shieldDuration = SHIELD_DURATION_FRAMES;
  shieldSound.start();
}

function triggerDisaster() {
  disasterActive = true;
  disasterDuration = DISASTER_DURATION_FRAMES;
  meteoroidSynth.triggerAttackRelease("16n");
  meteors.push({
    x: Math.random() * canvas.width,
    y: -50,
    radius: 20,
    speed: gameSpeed * 2
  });
}

// ========================= üéÆ COLLISION DETECTION =========================
function isColliding(a, b) {
  return (
    a.x < b.x + b.width &&
    a.x + a.width > b.x &&
    a.y < b.y + b.height &&
    a.y + a.height > b.y
  );
}

// ========================= üéÆ GAME LOOP =========================
function updateGame() {
  if (gameOver) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Road
  drawRoadLines();

  // Nitro effect
  if (nitroActive) {
    gameSpeed = BASE_GAME_SPEED * NITRO_SPEED_MULTIPLIER;
    backgroundSpeed = gameSpeed;
    nitroDuration--;
    nitroFill.style.width = `${(nitroDuration / NITRO_DURATION_FRAMES) * 100}%`;

    if (nitroDuration <= 0) {
      nitroActive = false;
      gameSpeed = BASE_GAME_SPEED;
      backgroundSpeed = BASE_GAME_SPEED;
    }
  } else {
    if (nitroCooldown > 0) nitroCooldown--;
    nitroFill.style.width = `${100 - (nitroCooldown / NITRO_COOLDOWN_FRAMES) * 100}%`;
    gameSpeed = BASE_GAME_SPEED;
    backgroundSpeed = BASE_GAME_SPEED;
  }

  // Shield timer
  if (shieldActive) {
    shieldDuration--;
    shieldDisplay.style.display = "block";
    shieldTimeDisplay.textContent = Math.ceil(shieldDuration / 60);

    if (shieldDuration <= 0) {
      shieldActive = false;
      shieldDisplay.style.display = "none";
    }
  }

  // Disaster timer
  if (disasterActive) {
    disasterDuration--;
    if (disasterDuration <= 0) {
      disasterActive = false;
      meteors = [];
    }
  }

  // Player
  drawCar(player.x, player.y, playerCarDesign);

  // Obstacles
  for (let i = obstacles.length - 1; i >= 0; i--) {
    const obs = obstacles[i];
    drawCar(obs.x, obs.y, opponentCarDesign);
    obs.y += obs.speed;

    if (isColliding(player, obs)) {
      if (shieldActive) {
        obstacles.splice(i, 1);
        explosionParticles.push({ x: obs.x, y: obs.y, radius: 20, life: 30 });
      } else {
        endGame();
        return;
      }
    }
    if (obs.y > canvas.height) {
      obstacles.splice(i, 1);
      score++;
      overtakeSynth.triggerAttackRelease("C4", "8n");
    }
  }

  // Shields
  for (let i = shields.length - 1; i >= 0; i--) {
    const s = shields[i];
    ctx.fillStyle = "cyan";
    ctx.beginPath();
    ctx.arc(s.x + s.width / 2, s.y + s.height / 2, 15, 0, Math.PI * 2);
    ctx.fill();
    s.y += s.speed;

    if (isColliding(player, s)) {
      activateShield();
      shields.splice(i, 1);
    }
  }

  // Disasters
  for (let i = disasters.length - 1; i >= 0; i--) {
    const d = disasters[i];
    ctx.fillStyle = "orange";
    ctx.fillRect(d.x, d.y, d.width, d.height);
    d.y += d.speed;

    if (isColliding(player, d)) {
      triggerDisaster();
      disasters.splice(i, 1);
    }
  }

  // Meteors
  for (let i = meteors.length - 1; i >= 0; i--) {
    const m = meteors[i];
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.arc(m.x, m.y, m.radius, 0, Math.PI * 2);
    ctx.fill();
    m.y += m.speed;

    if (isColliding(player, m)) {
      if (shieldActive) {
        meteors.splice(i, 1);
      } else {
        endGame();
        return;
      }
    }
  }

  // Explosions
  for (let i = explosionParticles.length - 1; i >= 0; i--) {
    const p = explosionParticles[i];
    ctx.fillStyle = `rgba(255, 100, 0, ${p.life / 30})`;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
    ctx.fill();
    p.life--;
    if (p.life <= 0) explosionParticles.splice(i, 1);
  }

  // Score
  scoreDisplay.textContent = score;
  highScore = Math.max(score, highScore || 0);
  highScoreDisplay.textContent = highScore;

  // Spawns
  if (Math.random() < 0.02) spawnObstacle();
  spawnShield();
  spawnDisaster();

  requestAnimationFrame(updateGame);
}

// ========================= üéÆ START / END GAME =========================
function startGame() {
  resetGame();
  introOverlay.style.display = "none";
  gameOver = false;
  requestAnimationFrame(updateGame);
}

function endGame() {
  gameOver = true;
  gameOverSynth.triggerAttackRelease("C2", "1n");
  introOverlay.style.display = "flex";
}

// ========================= üéÆ INPUT HANDLING =========================
document.addEventListener("keydown", e => {
  if (gameOver) return;
  if (e.key === "ArrowLeft" && player.x > 0) player.x -= player.speed * 2;
  if (e.key === "ArrowRight" && player.x < canvas.width - player.width) player.x += player.speed * 2;
  if (e.key === " ") activateNitro();
});

canvas.addEventListener("touchstart", e => {
  isDragging = true;
});

canvas.addEventListener("touchmove", e => {
  if (isDragging && e.touches[0]) {
    player.x = e.touches[0].clientX - canvas.offsetLeft - player.width / 2;
  }
});

canvas.addEventListener("touchend", e => {
  isDragging = false;
});

nitroBtn.addEventListener("click", activateNitro);

// ========================= üé∂ MUSIC MODAL =========================
let popupShown = sessionStorage.getItem('musicPopupShown') === 'true';

playButton.addEventListener("click", function(e) {
  if (!popupShown) {
    e.preventDefault();
    musicModal.style.display = 'flex';
  } else {
    Tone.start();
    startGame();
  }
});

modalYes.onclick = function() {
  popupShown = true;
  sessionStorage.setItem('musicPopupShown', 'true');
  musicEnabled = true;
  localStorage.setItem('musicEnabled', 'true');
  bgMusic.muted = false;
  musicToggle.textContent = 'üîä';
  musicToggle.classList.remove('off');
  musicModal.style.display = 'none';
  Tone.start();
  startGame();
};

modalCancel.onclick = function() {
  popupShown = true;
  sessionStorage.setItem('musicPopupShown', 'true');
  musicEnabled = false;
  localStorage.setItem('musicEnabled', 'false');
  bgMusic.muted = true;
  musicToggle.textContent = 'üîá';
  musicToggle.classList.add('off');
  musicModal.style.display = 'none';
  Tone.start();
  startGame();
};

musicModal.addEventListener('click', function(e) {
  if (e.target === musicModal) {
    musicModal.style.display = 'none';
  }
});
</script>
</body>
</html>
